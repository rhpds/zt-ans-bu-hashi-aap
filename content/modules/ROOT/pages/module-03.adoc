:doctype: book

= Trigger Infrastructure Provisioning and automation from Terraform Enterprise - Part 2

In this part we will continue the prerequisites and put the final touches on the Terraform Enterprise Workspace.

The follwoing diagram shows the overall scenario that we started in the previous lab section.

image::module2-3scenario.png[]

Let's work through to completion of this scenario.

* Terraform Enterprise
** Import a GitHub repository to your account
** Create a Terraform Enterprise Workspace that uses Version Control System (VCS, in this case GitHub) to store the Terraform code
** Trigger Terraform infrastructure provisioning and automation by committing changes to the Terraform code in the GitHub repository.

In this challenge you will learn how to bring in HashiCorp Vault Enterprise to your automation pipeline.

[#task1]
== Import the GitHub repository to your account

NOTE: To create your own UNLINKED GitHub repository, Use the GitHub.com UI to `IMPORT REPOSITORY` from an existing repository.
The following repository contains the Terraform code for the infrastructure you will be provisioning.

* https://github.com/ansible-tmm/aap-hashi-lab-2.git  # This is the repository you will be importing to your account
* While logged in to Github.com with your acccount, the top right corner click on the `+` icon, and select `Import repository`

image::importrepo.png[]

* In the `Repository URL` field, enter the URL of the repository you want to import, in this case: https://github.com/ansible-tmm/aap-hashi-lab-2.git
* Scroll down and enter a `Repository name` for your new repository, in this case: `aap-hashi-lab-2` (or another name if you prefer)
* Click on the `Begin import` button to import the repository to your account.

Later in this lab, you will be committing changes to the Terraform code in the GitHub repository, which in turn will trigger the Terraform infrastructure provisioning and automation, and will retrieve secrets from Vault Enterprise.

[#task2]
== Set up the Terraform Enterprise Workspace

We now want to create a new Terraform Enterprise Workspace that uses *Version Control System (VCS)* to store the Terraform code. By doing this, you will be able to trigger the Terraform infrastructure provisioning and Ansible automation by committing changes to the Terraform code in the GitHub repository that you imported earlier.

Back in the Terraform Enterprise UI, click on the `Workspaces` menu option in the left menu.

* Click on the `New` button on the right, and select `Workspace` from the dropdown.
* Enter the following details:
* For the `Project` field, select `rhdp-initial-project` from the dropdown, and select `Create`

image::workspace1.png[]

* On the next screen choose `Version Control Workflow` for the Workspace type

image::workspace2.png[]

Now you will need to configure the Workspace to use the GitHub repository you cloned earlier into your GitHub account.

* Select the `GitHub` option from the dropdown, and then click on the `GitHub.com` button.
* For the `VCS Provider` field, select `GitHub.com`
* You will now be launced to step 2 (`Set up provider`), which is to setup the GitHub repository connection
* Click the `Register a new OAuth Application` link to register a new OAuth application with GitHub.

image::workspace3.png[]

* Authenticate to `your GitHub account`, and authorize the Terraform Enterprise OAuth application to access your GitHub account.
* **It will have automatically populated some of the fields for you as they relate to Terraform Enterprise**
* Scroll down and click on the `Register application` button

image::workspace4.png[]

* The applciation will now be registered, and you will need to click the `Generate a new client secret` button to generate a new client secret. 
* You will be prompted to login to your GitHub account, please do so.
* Copy both the `Client ID` and `Client Secret`, you will need these momentarily.

image::workspace5.png[]

BACK in the `Terraform Enterprise UI`, please do the following:

* For the `Name` field, enter your initials, followed by dash and github, example: `jdoe-github`
* Paste the `Client ID` to the Client ID field.
* Paset the `Client Secret` to the Client Secret field.
* Click on the `Connect and Continue` button to save the VCS provider configuration
* You will be redirected to GitHub.com to authorize the Terraform Enterprise application to access your GitHub account, please authenticate and authorize!.
* Scroll to the bottom of the screen and click on the `Skip and Finish` button

image::workspace6.png[]

* On the next screen, you will need to choose the repository you want to use for this workspace. For this lab, we will use the repository you imported earlier into your GitHub account

image::workspace6-1.png[]

* On the following screen, you will need to provide the `Workspace Name`.  For this lab, we will use `TFE-Demo-VCS`
* For the `Description` field, enter `Using GitHub commits to trigger Plan/Apply Runs`
* Expand the `Advanced Options` section, and check both of the `Auto-apply` option checkboxes. This will automatically apply the changes to the workspace when you commit changes to the repository.
* For the `Terraform Working Directory` field, enter `TF_templates/AWS/`

|===
| Field | Value

| Workspace Name
| TFE-Demo-VCS

| Description
| Using GitHub commits to trigger Plan/Apply Runs

| Terraform Working Directory
| **TF_templates/AWS/**
|===

* Scroll down the bottom of the screen and click on the `Create` button to save the workspace configuration

image::workspace7.png[]

While you still have GitHub open, navigate to the repository you cloned earlier into your GitHub account please perform the following:

* Navigate to the repository `SETTINGS` -> `WEBHOOKS`
* You will see the Terraform Enterprise webhook configuration, click on the `Edit` button
* Scroll down to the `SSL verification` section, and check the `Disable` checkbox
* Authenticate to your GitHub account if prompted

image::workspace8.png[]

* You will now see that the Terraform Enterprise Workspace is now created successfully.

image::workspace9.png[]

* Don't accept the auto detected variables, and click on `Go to Workspace Overview`
* Click on the `Go to Workspace Overview` link to navigate to the workspace dashboard
* On this page, click on the `Configure Variables` button

image::workspace10.png[]

* On the next screen, add the following `Terraform variables`:

|===
| Field | Value | Sensitive

| vault_addr
| Add **YOUR VAULT host here**, example: `https://vault-guid#-1.apps.ocpvdev01.rhdp.net`
| No

| vault_role_id
| <your vault role id>
| No

| vault_secret_id
| <your vault secret id>
| Yes

| aap_host
| Add **YOUR AAP host here**, example: `https://control-guid#-1.apps.ocpvdev01.rhdp.net
| No

| aap_username
| admin
| No

| aap_password
| ansible123!
| Yes

| aws_access_key
| <your aws access key id>
| No

| aws_secret_key
| <your aws secret access key>
| Yes
|===

image::workspacevars1.png[]



[#task3]
== Trigger infrastructure provisioning and automation

Now we're all set to trigger the infrastructure provisioning and automation from Terraform Enterprise by committing changes to the Terraform code in the GitHub repository, later in the next lab section.

=== Commit changes to the Terraform code in the GitHub repository

* Navigate to the repository you cloned earlier into your GitHub account
* Click on the `Code` tab, and go to the `TF_templates/AWS/` folder
* Select the `terraform.tfvars` file, and on the right click on the `Pencil` and select `In place`
* Chance the `instance_count = 0` to `instance_count = 2`
* Click on the `Commit changes` button to commit the changes to the repository, then click `Commit` directly to the main branch

image::gitcommit1.png[]

=== What will happen now?

Plan and Apply in Terraform Enterprise will be triggered, and the infrastructure will be provisioned.
TFE will then trigger the `WF-Launched by TFE` workflow template
Terraform Inventory will be synchronized with the new resources
Ansible Automation Platform will then use the new resources to install Nginx on the new EC2 instances (Getting the SSH private key from Vault Enterprise)

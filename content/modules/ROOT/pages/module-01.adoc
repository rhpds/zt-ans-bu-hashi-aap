:doctype: book

= *Terraform Enterprise & Red Hat Ansible Automation Platform*
image::main.png[]

Welcome!!! 

Terraform (Enterprise and HCP Terraform) is a great tool you can use for deploying cloud infrastructure using delcarative Infrastructure as Code (IaC).
It allows you to define infrastructure as code and then build, modify, and destroy these resources declaratively.
Terraform (Enterprise and HCP Terraform) can be a simple way to deploy infrastructure, however if you add Ansible Automation Platform, together they can be used to automate the entire infrastructure lifecycle, from build to deploy, to manage, and to retire infrastructure, to enhance your automation journey!

image::aaptfmain.png[]

Estimated time to complete: _45 minutes_

* Welcome to the `Terraform Enterprise & Red Hat Ansible Automation Platform` lab.
In the following challenge tasks you will use Ansible Automation Platform and Terraform Enterprise together.
Centrally from Ansible Automation Platform you will trigger an Ansible Workflow that will use Terraform to create cloud Infrastructure, and then synchronize the inventory back into Ansible Automation Platform, and go on to perform other configuration and orchestration tasks.

* In this first challenge you will learn
** How to create an Ansible Workflow template and run it to create resources in AWS using Terraform Enterprise and Ansible Automation Platform will perform further configuration and orchestration tasks.

There are `several prerequisites` that you will need to complete before you can start this lab. These are:


==  Create a Terraform Enterprise credential type.
An Ansible Credential Type defines a structure (schema) for storing and using secrets like passwords, SSH keys, or API tokens, allowing secure management within Ansible Automation Platform for connecting to systems in this example Terraform Enterprise.

This task is done in Ansible Automation Platform.

image::tfecredtype.png[]


== Create the Terraform Enterprise API token

This task is done in Terraform Enterprise.

image::tfetoken.png[]

== Create an Terraform Enterprise Workspace

This task is done in Terraform Enterprise.

image::tfeworkspace1.png[]

== Create the Terraform Enterprise Credential in Ansible Automation Platform

This task is done in Ansible Automation Platform.

image::tfecred.png[]

=== Log in to the `Ansible Automation Platform` and create the Workflow template

Click on the `Ansible Automation Platform` tab at the top of lab.

Log in using the following *Login Credentials:*  

* `User:  admin`
* `Password:  ansible123!`

Credentials are utilized for authentication when launching Jobs against machines, synchronizing with inventory sources, and importing project content from a version control system.
In this lab, we have created some different credentials, for example.

* `AWS_Credential` - This is the AWS credential for performing actions against resources on AWS cloud.
For example, creating a VPC, or other AWS resources, or shutting down an instance, or installing and configuring an OS or configuring other AWS services.
Pretty much anything you need to perform in AWS.


* `SSH Controller Credentials` - This is an SSH key for the Ansible Automation Platform.
Often you will also have SSH machine credentials to gain SSH access to the Operating systems like RHEL.

Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Infrastructure` -> `Credentials`.
Click on the `Credentials` link and examine some of pre-configured credentials

NOTE: The keys are encrypted so no one, not even an administrator, can see the keys once placed in Ansible Automation Platfrom as a credential.

. Click on `+ Create credential`
. For the `Name` enter `Terraform Enterprise credential`
. Expand the `Credential Type` drop-down, and select `Terraform Enterprise credential type`
. In the `Organization` section enter `rhdp-tf-org`
. In the `Workspace` section enter `TFE-Demo`
. In the `Token` section enter the API token you generated earlier in Terraform Enterprise
. Click on `Create credential` to save the credential


== Terraform Inventory

An Inventory is a collection of hosts against which automation jobs may be launched.
Inventories.
You can source your inventory data from external sources and cloud providers.

=== In `Ansible Automation Platform`, create the Terraform inventory source

Click on the `Ansible Automation Platform` tab at the top of lab.
(if not already)

Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Infrastructure` -> `Inventories`.

Notice that there is an inventory that we've created for you called `Terraform Inventory`.

Click on this inventory, and then select the `Sources` tab.
Click the `+ Create Source` and then enter the following details.

|===
| Field | Value

| Name
| AWS source for TFE resources

| Execution environment
| Terraform Execution Environment

| Source
| Amazon EC2

| Credential
| AWS Credential

| Verbosity
| 0 (Warning)

| Overwrite
| Check

| Update on launch
| Check

| Cache timeout (seconds)
| 0
|===

ADD the following to the `Source variables` section
[source,yaml,role=execute]
----
---
hostnames:
  - tag:Name
compose:
  ansible_host: public_ip_address
----

Scroll to the bottom Click the blue `Create source` button to **save** the Inventory Source.

image::tfinventorysource.png[]

== Create a Workflow Template to kick off a Terraform Enterprise `**PLAN and APPLY**` operation

In this Task we will create an Ansible Job Template that will kick off a Terrafrom project.
The Terraform project is a simple project that will leverage the AWS provider to create an EC2 instance in the AWS cloud account you are using.

NOTE: *Please note that you can also do this in Azure and Google Cloud in the same way as you are here with AWS*

=== Create the first job template

Click on the `Ansible Automation Platform` tab at the top of lab.
(if not already) Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Templates`.
Now click on `+ Create Template`

Fill out the following fields:
|===
| Field | Value

| Name
| Terraform Enterprise APPLY

| Inventory
| Terraform Inventory

| Project
| Terraform Demos Project

| Playbook
| playbooks/terraform_cloud_apply_plan.yml

| Execution environment
| Terraform Execution Environment

| Credentials
| "AWS Credential" *AND* "Terraform Enterprise credential"
|===

ADD the following to the `extra variables` section

[source,yaml,role=execute]
----
---
aws_region: us-east-1
aws_name_tag: tfevm
aws_instance_size: t2.medium
aws_instance_count: 1
terraform_provision_resources: true
----

Scroll to the bottom Click the blue `Create Job Template` button to **save** the job template.

image::templateapply1.png[]

=== Create the `Terraform Enterprise APPLY Workflow` workflow template, and it's nodes




Launch the `Terraform Enterprise APPLY Workflow` template by selecting it and clicking on `ðŸš€ Launch template`, or by simply clicking the `Rocket Launcher` ðŸš€ icon, depending on where you are in the templates view.  The job status will show `Running` momentarily.

* Observe the output of the Workflow Template run. You will see the nodes running and the workflow visualizer showing the flow of the workflow.


=== Inspect the Terraform Inventory in Ansible Automation Platform
Select the `Terraform Inventory`, and then click on the `Hosts` menu.  Notice that there is NO Terraform inventory available yet.

Now click on the `Sources` menu and click on  `ðŸš€ Launch Inventory Update` icon.

Return to the `Hosts` menu, and notice that you have an EC2 instance that was create by Terraform now part of your inventory.

* Observe the resource count in the Terraform Enterprise console. You will see the resources created by Terraform.


=== Create and Launch a Workflow template to `**DESTROY**` the created resources
Start by creating the another job template to trigger a `Terraform Entperprise destroy operation` to destroy the created resources.
Click on the `Ansible Automation Platform` tab at the top of lab. (if not already)
Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Templates`.
Now click on `+ Create Template` then scroll down and click  `Create job template`

Fill out the following fields:

|===
| Field | Value

| Name
| Terraform Enterprise DESTROY

| Inventory
| Terraform Inventory

| Project
| Terraform Demos Project

| Playbook
| playbooks/terraform_cloud_destroy_plan.yml

| Execution environment
| Terraform Execution Environment

| Credentials
| "AWS Credential"  *AND*  "Terraform Enterprise credential"
|===



=== Create the `Terraform Enterprise DESTROY Workflow` workflow template, and it's nodes



Launch the `Terraform Enterprise DESTROY Workflow` template by selecting it and clicking on `ðŸš€ Launch template`, or by simply clicking the `Rocket Launcher` ðŸš€ icon. The job status will show `Running` momentarily.

* Observe the output of the Workflow Template run. You will see the nodes running and the workflow visualizer showing the flow of the workflow.

* Observice the resources that were destroyed by Terraform in Ansible Automation Platform -> Inventory -> Terraform Inventory -> Hosts.

* Observe the resource count in the Terraform Enterprise console. You will see the resource count should be 0.



=== SUMMARY
*In this lab section you created an configured AAP and Terraform Enterprise to work together. You created Workflow templates in Ansible Automation Platform that kick off Terraform Enterprise to provision cloud resources, and then Ansible Automation Platform can perform further automation operations.

This work further enhances the **BETTER TOGETHER STORY!**, and additionally providing more options and choice for Automators and Infrastructure operators!*

:doctype: book

= *Terraform Enterprise & Red Hat Ansible Automation Platform*
image::main.png[]

Welcome!!! 

Terraform (Enterprise and HCP Terraform) is a great tool you can use for deploying cloud infrastructure using delcarative Infrastructure as Code (IaC).
It allows you to define infrastructure as code and then build, modify, and destroy these resources declaratively.
Terraform (Enterprise and HCP Terraform) can be a simple way to deploy infrastructure, however if you add Ansible Automation Platform, together they can be used to automate the entire infrastructure lifecycle, from build to deploy, to manage, and to retire infrastructure, to enhance your automation journey!

image::aaptfmain.png[]

Estimated time to complete: _45 minutes_

* Welcome to the `Terraform Enterprise & Red Hat Ansible Automation Platform` lab.
In the following challenge tasks you will use Ansible Automation Platform and Terraform Enterprise together.
Centrally from Ansible Automation Platform you will trigger an Ansible Workflow that will use Terraform to create cloud Infrastructure, and then synchronize the inventory back into Ansible Automation Platform, and go on to perform other configuration and orchestration tasks.

* In this first challenge you will learn
** How to create an Ansible Workflow template and run it to create resources in AWS using Terraform Enterprise and Ansible Automation Platform will perform further configuration and orchestration tasks.

There are `several prerequisites` that you will need to complete before you can start this lab. These are:

* Terraform Enterprise prerequisites
* Ansible Automation Platform prerequisites

[#task1]
== Create the Terraform Enterprise API token

This task is done in Terraform Enterprise. You will need to create an API token in Terraform Enterprise to use in Ansible Automation Platform to authenticate against Terraform Enterprise.

Login to Terraform Enterprise using the following *Login Credentials:*  

* `User:  admin`
* `Password:  ansible123!`

* Select the organization `rhdp-tf-org`.
* In the left menu, click on `Settings` to expand the organzation settings options, and then click on `API Tokens`.


To create the API token, you will need to navigate to the `Settings` menu in Terraform Enterprise.

* Click on `API Tokens` and then click on `Create Token`.
* select the `User Tokens` menu option, and then click on `account settings page` link.
* Click on the `Create an API token` buttom.
* In the `Description` field enter `Terraform Enterprise API Token for Ansible Automation Platform`.
* In the `Expiration` field keep the default value of `30 days`.

|===
| Field | Value

| Description
| Terraform Enterprise API Token for Ansible Automation Platform

| Expiration
| 30 days
|===

* Click on `Generate Token`, and then click on the `Copy to clipboard` button.
* Copy the API token to your clipboard, save it somewhere where you can easily find it.

image::tfetoken.png[]

image::tfetoken1.png[]

[#task2]
== Create an Terraform Enterprise Workspace

This task is done in Terraform Enterprise.

=== Create the Terraform Enterprise Workspace
Go back to the main menu. In the left menu, click on `Workspaces` and then click on `Create a workspace`.  Select `API-Driven Workflow` as the type of workspace.

image::tfeworkspace.png[]

Fill out the following fields:
|===
| Field | Value

| Name
| TFE-Demo

| Project
| **rhdp-initial-project**

| Description
| My Initial Workspace for my first TFE demo.
|===

Click on `Create` to save the workspace.

image::tfeworkspace1.png[]

The workspace is now created. You can now use this workspace for Terraform Enterprise runs.

image::tfeworkspace2.png[]

=== Add the AWS Keys to the Terraform Enterprise Workspace

While in the `TFE-Demo` workspace, click on the `Variables` menu option in the left menu.
Click on the `Variables` tab.

Click on the `+ Add variable` button.
Enter the following details:

* Select the `Environment variable` variable type.
* In the `Key` field enter `AWS_ACCESS_KEY_ID`.
* In the `Value` field enter the AWS Access Key ID. Get this from the `Cloud(AWS)` tab in your lab.
* Select the `Sensitive` checkbox.
* Click on `Add variable` to save the variable.

image::tfevariables.png[]

Repeat the process for the `AWS_SECRET_ACCESS_KEY` variable.

Click on the `+ Add variable` button.
Enter the following details:

* Select the `Environment variable` variable type.
* In the `Key` field enter `AWS_SECRET_ACCESS_KEY`.
* In the `Value` field enter the AWS Secret Access Key. Get this from the `Cloud(AWS)` tab in your lab.
* Select the `Sensitive` checkbox.
* Click on `Add variable` to save the variable.

image::tfevariables1.png[]

You have now added the AWS keys to the Terraform Enterprise Workspace.
You can now use these keys to authenticate against the AWS cloud account.

[#task3]
==  Create a Terraform Enterprise credential type.

This task is done in Ansible Automation Platform.

Click on the `Ansible Automation Platform` tab at the top of lab.

Log in using the following *Login Credentials:*  

* `User:  admin`
* `Password:  ansible123!`

An Ansible Credential Type defines a structure (schema) for storing and using secrets like passwords, SSH keys, or API tokens, allowing secure management within Ansible Automation Platform for connecting to systems in this example Terraform Enterprise.

Expand: Automation Execution -> Credentials -> Credential Types -> + Create Credential Type
|===
| Field | Value

| Name
| Terraform Enterprise credential type

| Description
| Terraform Enterprise credential type for Terraform Enterprise
|===

For the `Input configuration` add the following:

[source,yaml,role=execute]
----
---
#INPUT
fields:
  - id: hostname
    type: string
    label: Terraform Enterprise Hostname
  - id: org
    type: string
    label: Organization
  - id: workspace
    type: string
    label: Workspace
  - id: token
    type: string
    label: Token
    secret: true
required:
  - hostname
  - org
  - workspace
  - token
----

For the `Injector configuration` add the following:

[source,yaml,role=execute]
----
---
#INJECTOR
extra_vars:
  tf_hostname: '{{ hostname }}' # e.g. https://tfe-https-1234567890.apps.ocpvdev01.rhdp.net
  tf_org: '{{ org }}'
  tf_workspace: '{{ workspace }}'
  tf_token: '{{ token }}'
----

Click on `Create Credential Type` to save the credential type.

image::tfecredtype.png[]

[#task4]
== Create the Terraform Enterprise Credential in Ansible Automation Platform

Credentials are utilized for authentication when launching Jobs against machines, synchronizing with inventory sources, and importing project content from a version control system.
In this lab, we have created some different credentials.

This task is done in Ansible Automation Platform.

Log in to the `Ansible Automation Platform` 

Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Infrastructure` -> `Credentials`.
Click on the `Credentials` link and examine some of pre-configured credentials

NOTE: The keys are encrypted so no one, not even an administrator, can see the keys once placed in Ansible Automation Platfrom as a credential.

. Click on `+ Create credential`
. For the `Name` enter `Terraform Enterprise credential`
. Expand the `Credential Type` drop-down, and select `Terraform Enterprise credential type`
. In the `Terraform Enterprise Hostname` section enter `**<Your terraform hostname url>**`
. In the `Organization` (**Terraform Organization**) section enter `**rhdp-tf-org**`
. In the `Workspace` section enter `**TFE-Demo**`
. In the `Token` section enter the API token you generated earlier in Terraform Enterprise
. Click on `Create credential` to save the credential

|===
| Field | Value

| Name
| Terraform Enterprise credential

| Credential Type
| Terraform Enterprise credential type

| Terraform Enterprise Hostname
| **<Your terraform hostname url>** # This will look like: https://tfe-https-12345-a.apps.#######.rhdp.net

| Organization (**Terraform Organization**)
| **rhdp-tf-org**

| Workspace
| **TFE-Demo**

| Token
| <Your terraform api token> # This is the API token you generated earlier in Terraform Enterprise
|===

image::tfecred.png[]

[#task5]
== Terraform Inventory

An Inventory is a collection of hosts against which automation jobs may be launched.
Inventories.
You can source your inventory data from external sources and cloud providers.

=== In `Ansible Automation Platform`, create the Terraform inventory source

Click on the `Ansible Automation Platform` tab at the top of lab.
(if not already)

Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Infrastructure` -> `Inventories`.

Notice that there is an inventory that we've created for you called `Terraform Inventory`.

Click on this inventory, and then select the `Sources` tab.
Click the `+ Create Source` and then enter the following details.

|===
| Field | Value

| Name
| AWS source for TFE resources

| Execution environment
| Terraform Execution Environment

| Source
| Amazon EC2

| Credential
| AWS Credential

| Verbosity
| 1 (Info)

| Overwrite
| Check

| Update on launch
| Check

| Cache timeout (seconds)
| 0
|===

ADD the following to the `Source variables` section
[source,yaml,role=execute]
----
---
hostnames:
  - tag:Name
compose:
  ansible_host: public_ip_address
  ansible_ssh_pipelining: "true"  
----

Scroll to the bottom Click the blue `Create source` button to **save** the Inventory Source.

image::tfinventorysource.png[]

Click on the `Sync inventory source` button in the top right corner of the screen to synchronize the inventory source. You should see a status of `Success` shortly.

[#task6]
== Create a Workflow Template to kick off a Terraform Enterprise `**PLAN and APPLY**` operation

In this Task we will create an Ansible Job Template that will kick off a Terrafrom project, and then create the Workflow Template that will kick off the Job Template and then synchronize the inventory source.

The Terraform project is a simple project that will leverage the AWS provider to create an EC2 instance in the AWS cloud account you are using.

NOTE: *Please note that you can also do this in Azure and Google Cloud in the same way as you are here with AWS*

=== Create the `Terraform Enterprise APPLY` job template

Click on the `Ansible Automation Platform` tab at the top of lab.
(if not already) Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Templates`.
Now click on `+ Create job template`

Fill out the following fields:
|===
| Field | Value

| Name
| Terraform Enterprise APPLY

| Inventory
| **Demo Inventory**

| Project
| Terraform Demos Project

| Playbook
| playbooks/terraform_apply_plan.yml

| Execution environment
| Terraform Execution Environment

| Credentials
| Terraform Enterprise credential
|===

ADD the following to the `Source variables` section
[source,yaml,role=execute]
----
---
aws_region: us-east-1
aws_name_tag: tfevm
aws_instance_size: t2.medium
aws_instance_count: 1
aws_instance_public_key: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAKzl1JGwZh92P1ABxIVHE52I2nJk+h7ED4B6GgbMXAl hmourad@hmourad-mac
----

Scroll to the bottom Click the blue `Create  Job Template` button to **save** the job template.

image::templateapply1.png[]

=== Create the `WF-Terraform Enterprise APPLY` workflow template, and it's nodes

Click on the `Ansible Automation Platform` tab at the top of lab.
(if not already) Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Templates`.
Now click on `+ Create Workflow job template`

Fill out the following fields:
|===
| Field | Value

| Name
| WF-Terraform Enterprise APPLY

| Organization
| Default
|===

Scroll to the bottom Click the blue `Create Workflow Job Template` button to **save** the Workflow.

image::wftemplateapply1.png[]

=== Create the nodes for the `WF-Terraform Enterprise APPLY` workflow template

* Select `+ Add step` and then select the `Terraform Enterprise APPLY` job template you created earlier, Select `Next` to continue, and then `Finish` to save the node.

image::wftemplateapply2.png[]

* Click on the elipsis `...` at the end of the node, and then select `+ Add step and link`.
* For this next step change the `Node Type` to `Inventory Source Sync` and select the `AWS source for TFE Inventory`. Select `Next` then `Finish` to save this second step. This will synchronize the inventory source you created earlier.

image::wftemplateapply3.png[]

* Click on the elipsis `...` at the end of the node, and then select `+ Add step and link`.
* For this next step keep the `Node Type` to `Job Template` and select the `Install Nginx on RHEL` job template. Select `Next` then `Finish` to save this step.
** NOTE: The `Install Nginx on RHEL` job template is a job template that is already created for you in Ansible Automation Platform. It is used to install Nginx on the RHEL hosts.

Click on the `Save` button to save the workflow template.

image::wftemplateapply4.png[]

=== Launch the `WF-Terraform Enterprise APPLY` workflow template

Launch the `WF-Terraform Enterprise APPLY` workflow template by selecting it and clicking on `ðŸš€ Launch template`, or by simply clicking the `Rocket Launcher` ðŸš€ icon. The job status will show `Running` momentarily.

* Observe the output of the Workflow Template run. You will see the nodes running and the workflow visualizer showing the flow of the workflow.

image::wftemplateapply5.png[]

* Quickly switch to the `Terraform Enterprise` tab in your lab and observe the `plan` and then the `apply` being performed. Alspo notice the resouce count in the Terraform Enterprise console.

image::tfeapply1.png[]

=== Inspect the Terraform Inventory in Ansible Automation Platform
Select the `Terraform Inventory`, and then click on the `Hosts` menu. Notice that there is a new host that was created by Terraform and is now part of your Ansible inventory.

image::tfeapplyinventory.png[]

=== Validate the Nginx installation

* Open a browser tab and navigate to the public IP address of the EC2 instance that was created by Terraform. You will see the following page:

image::rhelnginx.png[]

[#task7]
== Create the `WF-Terraform Enterprise DESTROY` workflow template, and its nodes

In this task we will create a Workflow template to trigger a `Terraform Enterprise DESTROY` operation to destroy the previously created resources also followed up by and inventory sync to udpate the resources from the Ansible inventory.

=== Create the `Terraform Enterprise DESTROY` job template

Start by creating the another job template to trigger a `Terraform Entperprise destroy operation` to destroy the created resources.
Click on the `Ansible Automation Platform` tab at the top of lab. (if not already)
Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Templates`.
Now click on `+ Create Template` then scroll down and click  `Create job template`

Fill out the following fields:

|===
| Field | Value

| Name
| Terraform Enterprise DESTROY

| Inventory
| **Demo Inventory**

| Project
| Terraform Demos Project

| Playbook
| playbooks/terraform_destroy_plan.yml

| Execution environment
| Terraform Execution Environment

| Credentials
| Terraform Enterprise credential
|===

Scroll to the bottom Click the blue `Create Job Template` button to **save** the job template.

=== Create the `Terraform Enterprise DESTROY Workflow` workflow template, and it's nodes

Click on the `Ansible Automation Platform` tab at the top of lab.
(if not already) Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Templates`.
Now click on `+ Create Workflow job template`

Fill out the following fields:
|===
| Field | Value

| Name
| WF-Terraform Enterprise DESTROY
|===

Scroll to the bottom Click the blue `Create Workflow Job Template` button to **save** the Workflow.

=== Create the nodes for the `WF-Terraform Enterprise DESTROY` workflow template

* Select `+ Add step` and then select the `Terraform Enterprise DESTROY` job template you created earlier, Select `Next` to continue, and then `Finish` to save the node.

* Click on the elipsis `...` at the end of the node, and then select `+ Add step and link`.
* For this next step change the `Node Type` to `Inventory Source Sync` and select the `AWS source for TFE Inventory`. Select `Next` then `Finish` to save this second step.

Click on the `Save` button to save the workflow template.

=== Launch the `WF-Terraform Enterprise DESTROY` workflow template

Launch the `Terraform Enterprise DESTROY Workflow` template by selecting it and clicking on `ðŸš€ Launch template`, or by simply clicking the `Rocket Launcher` ðŸš€ icon. The job status will show `Running` momentarily.

* Observe the output of the Workflow Template run. You will see the nodes running and the workflow visualizer showing the flow of the workflow.

* Quickly switch to the `Terraform Enterprise` tab in your lab and observe the `destroy` being performed. Also notice the resouce count in the Terraform Enterprise console. You will see the resource count should be 0.

image::tfedestroy1.png[]

* Observe the resources that were destroyed by Terraform in Ansible Automation Platform -> Inventory -> Terraform Inventory -> Hosts.
** Here you will see that the host has been removed from the inventory and the resources have been destroyed.

=== SUMMARY

* In this lab section you created an configured AAP and Terraform Enterprise to work together.
* You created Workflow templates in Ansible Automation Platform that kick off Terraform Enterprise to provision cloud resources, and then Ansible Automation Platform performed further automation operations on the resources.
* You created a Workflow template to destroy the resources created by Terraform.

NOTE: **Even though this lab is focused on Terraform Enterprise and Ansible Automation Platform, you can also use HCP Terraform (also known as Terraform Cloud) and Ansible Automation Platform together in the EXACT SAME WAY!**

This work further enhances the **BETTER TOGETHER STORY!**, and additionally providing more options and choice for Automators and Infrastructure operators!
